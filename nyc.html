<!DOCTYPE html>
<html>
	<head>
		<link href="css/style.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="js/d3.v3.min.js"></script>

		<script src ="js/jquery-svgpan.js"></script>
		<style type="text/css">
			.node {
				cursor: pointer;
			}

			//.node circle {
				fill: #fff;
				stroke: #28abe3;
			}

			.node text {

				fill: #4d4d4d;
			}

			.link {
				fill: none;
				stroke: #b3b3b3;
			}

			

		</style>
	</head>
	<body>
		<div id="header"><img src = "img/logo43.png"></div>
		<div id="footer"><ul><li><a href ="#">About</a></li> <li><a href ="#">Blog</a></li>  <li><a href ="#">Content</a></li> </ul></div>
		<div id="chart"></div>

		<div id = "sidebar">
			Doubleclick a node with children to collapse it.
			Drag nodes to rearrange the layout.
			Use scroll wheel to zoom.
			Drag white space to pan.
			<div id="boxName"></div>
			<div id="boxText"></div>
			<div id="personName"></div>
			<div id="personText"></div>
			<div id="form">
				<form name="addbox" id="addbox" action="reformed/formmail/formmail.php">
					<label for="name">Add Subordinate</label>
					<br/>

					<input type="text" name = "name" id="newSubName"  />
					Name 					<textarea name="description" id="description" rows="6" cols="30">Enter text here...</textarea>
<br/>					description
					<input type='hidden' name = "superiorbox" id='uid' value=''>
					<br/>
					<a href="javascript: submitform()">Add</a>

				</form>
				<input type='hidden' name = "index" id='index' value=''>
			</div>
		</div>

		<script type="text/javascript">
			var w = 2000, h = 2000, node, link, root;
			var bodyheight = $(window).height();
			var bodywidth = $(window).width();
			var nodes;

			var resp;

			var commonscale = 1.5;

			//gravity and link length settings
			var force = d3.layout.force().on("tick", tick)

			//.charge(function(d) {

			//return shrink(-500, d.level, 1.4);

			//return d._children ? -d.size / 100 : -30;
			//}).linkDistance(function(d) {

			//return shrink(100, d.target.level, 2);

			//return d.target._children ? 80 : 30;

			//}).size([w, h - 160])

			.charge(function(d) {
				return shrink(-500, d.level, commonscale);

				//return d._children ? -100+(d.level*5) : (-30)+(d.level);
			}).linkDistance(function(d) {
				return shrink(100, d.target.level, commonscale)
				//return d.target._children ? shrink(60,d.target.level,commonscale) : shrink(30,d.target.level,commonscale);
			})
			//.linkDistance(50)

			.linkStrength(1).gravity(.2).theta(.1).size([bodywidth, bodyheight]).theta(1.5).friction(.5);

			var vis = d3.select("#chart").append("svg:svg").attr("width", bodywidth).attr("height", bodyheight).append("g").attr("transform", "translate(0,0)").attr("id", "viewport")

			d3.json("http://www.govsee.com/php/getgovjson.php?gov=NYC.json", function(json) {
				root = json;
				root.fixed = true;
				root.x = bodywidth / 2;
				root.y = bodyheight / 2;
				update();
			});

			function update() {
				//if (!nodes) {
				nodes = flatten(root), links = d3.layout.tree().links(nodes);
				//}

				// Update the links…
				link = vis.selectAll("line.link").data(links, function(d) {
					return d.target.id;
				});

				// Enter any new links.
				link.enter().insert("svg:line").attr("class", "link").attr("x1", function(d) {
					console.log("sourcex: " + d.source.x);
					return d.source.x;

				}).attr("y1", function(d) {
					console.log("sourcey: " + d.source.y);
					return d.source.y;
				}).attr("x2", function(d) {
					console.log("targetx: " + d.target.x);
					return d.target.x;
				}).attr("y2", function(d) {
					console.log("targety: " + d.target.x);
					return d.target.y;
				}).attr("stroke-width", function(d) {

					return shrink(3, d.target.level, commonscale) + "px";

				});

				// Exit any old links.
				link.exit().remove();

				// Update the nodes…
				node = vis.selectAll("g.node").data(nodes, function(d) {
					return d.id;
				});
				//.style("fill", color)
				var nodeEnter = node.enter().append("g").attr("class", "node").attr("id",function(d){
					return d.id;	
					
				}).on("click", click).call(force.drag).on("click", click).on("dblclick", dblclick);

				//node.transition()
				//.attr("r", function(d) { return d.children ? 4.5 : Math.sqrt(d.size) / 10; });
				//.attr("r", function(d) {
				// x=10;

				// for(i=0;i<d.level;i++){

				//	x=x/2;
				// }

				// return x;

				// });

				// Enter any new nodes.
				var circle = nodeEnter.append("svg:circle")
				//.attr("class", "node")
				//.attr("cx", function(d) { return d.x; })
				//.attr("cy", function(d) { return d.y; })
				//.attr("r", function(d) { return d.children ? 4.5 : Math.sqrt(d.size) / 10; })
				.attr("r", function(d) {

					return shrink(8, d.level, commonscale);

				})
				//.attr("r", "4.5")
				.style("fill", color)
				//.style("stroke-width", "6.5px")
				//.style("stroke-width", function(d) {

					//return shrink(6.5, d.level, commonscale);

				//})
				.attr("class","c");
				//.on("click", click)
				//.call(force.drag);

				//Adds Box Name
				var nameText = nodeEnter.append("svg:text").attr("x", function(d) {
					return shrink(15, d.level, commonscale);
				}).attr("text-anchor", "left").attr("transform", "rotate(0)").text(function(d) {
					if (d.name == "NYC.json") {
						d.name = "NYC";
					}

					return d.name;
				}).style("font", function(d) {

					return shrink(7, d.level, commonscale) + "px ProximaNova";
				});
				//.style("font-weight", "bold");

				//}).style("font", "5px sans-serif");
				//.style("fill-opacity", 1e-6)
				// Exit any old nodes.

				//Adds Person Name
				var personText = nodeEnter.append("svg:text").attr("x", function(d) {
					return shrink(15, d.level, commonscale);
				}).attr("y", function(d) {

					return shrink(8, d.level, commonscale) + "px";
				}).attr("text-anchor", "left").attr("transform", "rotate(0)").text(function(d) {

					return d.personname;
				}).style("font", function(d) {

					return shrink(7, d.level, commonscale) + "px ProximaNova";
				});

				//Adds Debug Text for the node's charge
				//var personText = nodeEnter.append("svg:text").attr("x", function(d) {
				//return shrink(15, d.level, commonscale);
				//}).attr("y", function(d) {

				//	return shrink(16, d.level, commonscale) + "px";
				//}).attr("text-anchor", "left").attr("transform", "rotate(0)").text(function(d) {

				//	return shrink(-80, d.level, commonscale).toFixed(2) + " " + shrink(50,d.level,commonscale).toFixed(2);

				//}).style("font", function(d) {

				//return shrink(9, d.level, commonscale) + "px Trebuchet MS";
				//});

				//Add Image
				//node.append("image").attr("xlink:href", function(d) {
				//	if (d.image) {
				//		x = "http://www.jfxart.com/zulu7/img/" + d.image;
				//	} else {

				//		x = "http://www.jfxart.com/zulu7/img/nophoto.gif"
				//	}
				//	return x;
				//}).attr("width", 20).attr("height", function(d) {

				//	return shrink(15,d.level);
				//}).attr("x", -10).attr("y",function(d){
				//	return shrink(-8,d.level);
				//});

				node.exit().remove();

				// Restart the force layout.
				force.nodes(nodes).links(links).start();
			}


			$('svg').svgPan('viewport');

			function tick() {
				link.attr("x1", function(d) {
					return d.source.x;
				}).attr("y1", function(d) {
					return d.source.y;
				}).attr("x2", function(d) {
					return d.target.x;
				}).attr("y2", function(d) {
					return d.target.y;
				});

				//node.attr("cx", function(d) { return d.x; })
				//  .attr("cy", function(d) { return d.y; });

				node.attr("transform", function(d) {
					return "translate(" + d.x + "," + d.y + ")";
				});

			}

			// Color leaf nodes orange, and packages white or blue.
			function color(d) {
				return d.children ? "#62b144" : "#29aae3";
			}

			// Toggle children on click.
			function dblclick(d) {
				if (d.children) {
					d._children = d.children;
					d.children = null;
				} else {
					d.children = d._children;
					d._children = null;
				}
				update();
			}

			//Click
			function click(d) {
				
				var x = d3.select(this).select("circle");
				console.log(x);
				x.attr("r", shrink(10,d.level,commonscale)).style("fill", "#ffffff")
				.style("stroke-width",shrink(6.5,d.level,commonscale)).style("stroke",color);
				
				
				var s = document.getElementById("boxName");
				s.innerHTML = d.name;

				var s = document.getElementById("personName");
				s.innerHTML = d.personname;

				pullUrl = "http://www.jfxart.com/zulu7/pull.php"

				$.ajax({
					type : "GET",
					data : "nodeID=" + d.uid + "&personID=" + d.person,
					url : pullUrl,
					dataType : "json",
					success : function(data) {
						var s = document.getElementById("boxText");
						s.innerHTML = data.node;

						var s = document.getElementById("personText");
						s.innerHTML = data.person;

					}
				});

				$('#uid').val(d.uid);
				$('#index').val(d.index);
				update();

			}

			//reduces, pass it the original value and the level
			function shrink(x, level, rate) {

				for ( i = 0; i < level; i++) {

					x = x / rate;
				}

				return x;

			}

			// Returns a list of all nodes under the root.
			function flatten(root) {
				var nodes = [], i = 0;

				function recurse(node) {
					if (node.children)
						node.size = node.children.reduce(function(p, v) {
							return p + recurse(v);
						}, 0);
					if (!node.id)
						node.id = ++i;
					nodes.push(node);

					return 100;
					//return node.size;
				}


				root.size = recurse(root);
				return nodes;
			}

			function submitform() {
				var newSubName = document.getElementById("newSubName").value;

				//alert(newSubName + " " + description + " " + newSubUid);
				var s = $('#addbox').serialize();
				console.log(s);

				$.ajax({
					type : 'POST',
					url : 'http://www.govsee.com/php/insertbox.php',
					dataType : 'html',
					data : $('#addbox').serialize(),
					complete : function(response) {
						//test funtion to add a child node
						resp = response;
						var ind = document.getElementById("index").value;
						var parentNode = nodes[ind];

						var newNode = {
							id : nodes.length + 1,
							name : newSubName,
							level : parentNode.level + 1,
							uid : response.responseText
						};

						nodes.push(newNode);

						var newLink = {
							source : parentNode,
							target : newNode
						};

						links.push(newLink);
						update();

					}
				});

			}


			$(window).resize(function() {
				bodyheight = $(window).height();
				bodywidth = $(window).width();
				$("#chart").height(bodyheight);
				$("#chart").width(bodywidth);
			});

		</script>
	</body>
</html>